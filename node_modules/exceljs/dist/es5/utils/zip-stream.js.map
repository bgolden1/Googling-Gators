{"version":3,"sources":["../../../lib/utils/zip-stream.js"],"names":["events","require","JSZip","StreamBuf","ZipReader","options","count","jsZip","stream","on","_process","getEntryType","process","nextTick","emit","content","read","loadAsync","zip","forEach","path","entry","dir","async","data","entryStream","write","autodrain","_finished","encoding","callback","error","result","cork","uncork","end","EventEmitter","ZipWriter","Object","assign","type","compression","hasOwnProperty","base64","file","name","generateAsync","size","setEncoding","pause","resume","isPaused","destination","pipe","unpipe","chunk","unshift","wrap","module","exports"],"mappings":"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","sourcesContent":["/* eslint-disable max-classes-per-file */\r\nconst events = require('events');\r\nconst JSZip = require('jszip');\r\n\r\nconst StreamBuf = require('./stream-buf');\r\n\r\n// The purpose of this module is to wrap the js-zip library into a streaming zip library\r\n// since most of the exceljs code uses streams.\r\n// One day I might find (or build) a properly streaming browser safe zip lib\r\n\r\n// =============================================================================\r\n// The ZipReader class\r\n// Unpacks an incoming zip stream\r\nclass ZipReader extends events.EventEmitter {\r\n  constructor(options) {\r\n    super();\r\n\r\n    this.count = 0;\r\n    this.jsZip = new JSZip();\r\n    this.stream = new StreamBuf();\r\n    this.stream.on('finish', () => {\r\n      this._process();\r\n    });\r\n    this.getEntryType = options.getEntryType || (() => 'string');\r\n  }\r\n\r\n  _finished() {\r\n    if (!--this.count) {\r\n      process.nextTick(() => {\r\n        this.emit('finished');\r\n      });\r\n    }\r\n  }\r\n\r\n  async _process() {\r\n    try {\r\n      const content = this.stream.read();\r\n      const zip = await this.jsZip.loadAsync(content);\r\n      zip.forEach(async (path, entry) => {\r\n        if (!entry.dir) {\r\n          this.count++;\r\n          try {\r\n            const data = await entry.async(this.getEntryType(path));\r\n            const entryStream = new StreamBuf();\r\n            entryStream.path = path;\r\n            entryStream.write(data);\r\n            entryStream.autodrain = () => {\r\n              this._finished();\r\n            };\r\n            entryStream.on('finish', () => {\r\n              this._finished();\r\n            });\r\n\r\n            this.emit('entry', entryStream);\r\n          } catch (error) {\r\n            this.emit('error', error);\r\n          }\r\n        }\r\n      });\r\n    } catch (error) {\r\n      this.emit('error', error);\r\n    }\r\n  }\r\n\r\n  // ==========================================================================\r\n  // Stream.Writable interface\r\n  async write(data, encoding, callback) {\r\n    if (this.error) {\r\n      if (callback) {\r\n        callback(this.error);\r\n      }\r\n      throw this.error;\r\n    } else {\r\n      try {\r\n        const result = await this.stream.write(data, encoding, callback);\r\n        return result;\r\n      } catch (err) {\r\n        this.emit('error', err);\r\n        return err;\r\n      }\r\n    }\r\n  }\r\n\r\n  cork() {\r\n    return this.stream.cork();\r\n  }\r\n\r\n  uncork() {\r\n    return this.stream.uncork();\r\n  }\r\n\r\n  end() {\r\n    return this.stream.end();\r\n  }\r\n\r\n  destroy(error) {\r\n    this.emit('finished');\r\n    this.error = error;\r\n  }\r\n}\r\n\r\n// =============================================================================\r\n// The ZipWriter class\r\n// Packs streamed data into an output zip stream\r\nclass ZipWriter extends events.EventEmitter {\r\n  constructor(options) {\r\n    super();\r\n    this.options = Object.assign(\r\n      {\r\n        type: 'nodebuffer',\r\n        compression: 'DEFLATE',\r\n      },\r\n      options\r\n    );\r\n\r\n    this.zip = new JSZip();\r\n    this.stream = new StreamBuf();\r\n  }\r\n\r\n  append(data, options) {\r\n    if (options.hasOwnProperty('base64') && options.base64) {\r\n      this.zip.file(options.name, data, {base64: true});\r\n    } else {\r\n      this.zip.file(options.name, data);\r\n    }\r\n  }\r\n\r\n  async finalize() {\r\n    const content = await this.zip.generateAsync(this.options);\r\n    this.stream.end(content);\r\n    this.emit('finish');\r\n  }\r\n\r\n  // ==========================================================================\r\n  // Stream.Readable interface\r\n  read(size) {\r\n    return this.stream.read(size);\r\n  }\r\n\r\n  setEncoding(encoding) {\r\n    return this.stream.setEncoding(encoding);\r\n  }\r\n\r\n  pause() {\r\n    return this.stream.pause();\r\n  }\r\n\r\n  resume() {\r\n    return this.stream.resume();\r\n  }\r\n\r\n  isPaused() {\r\n    return this.stream.isPaused();\r\n  }\r\n\r\n  pipe(destination, options) {\r\n    return this.stream.pipe(destination, options);\r\n  }\r\n\r\n  unpipe(destination) {\r\n    return this.stream.unpipe(destination);\r\n  }\r\n\r\n  unshift(chunk) {\r\n    return this.stream.unshift(chunk);\r\n  }\r\n\r\n  wrap(stream) {\r\n    return this.stream.wrap(stream);\r\n  }\r\n}\r\n\r\n// =============================================================================\r\n\r\nmodule.exports = {\r\n  ZipReader,\r\n  ZipWriter,\r\n};\r\n"],"file":"zip-stream.js"}